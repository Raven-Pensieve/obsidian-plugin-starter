import builtins from "builtin-modules";
import esbuild from "esbuild";
import fs from "fs-extra";
import path from "node:path";
import process from "node:process";
import postcss from "postcss";
import postcssNesting from "postcss-nesting";

const banner = `/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
`;

// å‚æ•°è§£æï¼šæ”¯æŒ dev å’Œ prod ä¸¤ç§æ¨¡å¼
// ç”¨æ³•: node esbuild.config.mjs [dev|prod|production]
const args = process.argv.slice(2);
const mode = args[0] || "dev";
const prod = mode === "production" || mode === "prod";
const outDir = "dist";

/**
 * CSS æ–‡ä»¶é‡å‘½åæ’ä»¶
 * åœ¨æ„å»ºå®Œæˆåï¼Œå°† esbuild ç”Ÿæˆçš„ main.css é‡å‘½åä¸º styles.css
 * @returns {Object} esbuild æ’ä»¶å¯¹è±¡
 */
const renamePlugin = () => ({
	name: "rename-plugin",
	setup(build) {
		build.onEnd(async () => {
			const src = path.join(outDir, "main.css");
			const dest = path.join(outDir, "styles.css");

			if (fs.existsSync(src)) {
				try {
					fs.moveSync(src, dest, { overwrite: true });
				} catch (error) {
					console.error("Failed to rename CSS file:", error);
				}
			}
		});
	},
});

/**
 * CSS å¤„ç†æ’ä»¶
 * ä½¿ç”¨ PostCSS å’Œ postcss-nesting æ’ä»¶å¤„ç† CSS æ–‡ä»¶ï¼Œæ”¯æŒ CSS åµŒå¥—è¯­æ³•
 * åœ¨æ„å»ºè¿‡ç¨‹ä¸­è‡ªåŠ¨å¤„ç†æ‰€æœ‰ .css æ–‡ä»¶
 * @returns {Object} esbuild æ’ä»¶å¯¹è±¡
 */
const cssReBuild = () => ({
	name: "css-rebuild",

	setup(build) {
		// æ³¨å†Œä¸€ä¸ªåŠ è½½å™¨ï¼Œç”¨äºå¤„ç†æ‰€æœ‰ CSS æ–‡ä»¶
		// filter å‚æ•°æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é…æ‰€æœ‰ .css æ‰©å±•åçš„æ–‡ä»¶
		build.onLoad({ filter: /\.css$/ }, async (args) => {
			try {
				// è¯»å– CSS æ–‡ä»¶å†…å®¹
				// args.path åŒ…å«å½“å‰å¤„ç†çš„ CSS æ–‡ä»¶çš„å®Œæ•´è·¯å¾„
				const css = await fs.promises.readFile(args.path, "utf8");

				// ä½¿ç”¨ PostCSS å¤„ç† CSS æ–‡ä»¶
				// postcssNesting æ’ä»¶å…è®¸åœ¨ CSS ä¸­ä½¿ç”¨åµŒå¥—è¯­æ³•ï¼ˆç±»ä¼¼ SCSSï¼‰
				const result = await postcss([postcssNesting]).process(css, {
					from: args.path, // æŒ‡å®šæºæ–‡ä»¶è·¯å¾„ï¼Œç”¨äºç”Ÿæˆæ­£ç¡®çš„æºæ˜ å°„
				});

				// ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
				fs.ensureDirSync(outDir);

				// è¿”å›å¤„ç†åçš„ CSS å†…å®¹
				// contents: å¤„ç†åçš„ CSS ä»£ç 
				// loader: å‘Šè¯‰ esbuild å¦‚ä½•è§£é‡Šè¿™äº›å†…å®¹ï¼ˆä½œä¸º CSSï¼‰
				return {
					contents: result.css,
					loader: "css",
				};
			} catch (error) {
				// é”™è¯¯å¤„ç†ï¼šå¦‚æœ CSS å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°ä»»ä½•é”™è¯¯
				console.error("Error processing CSS:", error);

				// è¿”å›ç©ºå†…å®¹ï¼Œé¿å…æ„å»ºå®Œå…¨å¤±è´¥
				// è¿™æ ·å³ä½¿ CSS å¤„ç†å¤±è´¥ï¼Œæ„å»ºè¿‡ç¨‹ä»ç„¶å¯ä»¥ç»§ç»­
				return {
					contents: "",
					loader: "css",
				};
			}
		});
	},
});

// å¤åˆ¶ manifest.json åˆ°è¾“å‡ºç›®å½•
function copyManifest() {
	// ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
	fs.ensureDirSync(outDir);

	const src = path.join(process.cwd(), "manifest.json");
	const dest = path.join(process.cwd(), outDir, "manifest.json");
	try {
		fs.copyFileSync(src, dest);
		console.log("âœ“ å·²å¤åˆ¶ manifest.json åˆ° dist ç›®å½•");
	} catch (e) {
		console.error("âš  å¤åˆ¶ manifest.json å¤±è´¥:", e.message);
	}
}

// ç›‘å¬ manifest.json å˜åŒ–ï¼ˆå¸¦é˜²æŠ–å’Œå†…å®¹æ¯”è¾ƒï¼Œé¿å…é‡å¤è§¦å‘ï¼‰
function watchManifest() {
	const manifestPath = path.join(process.cwd(), "manifest.json");

	if (!fs.existsSync(manifestPath)) {
		return;
	}

	let copyTimer = null;
	let lastContent = fs.readFileSync(manifestPath, "utf8");

	fs.watch(manifestPath, (eventType) => {
		if (eventType === "change") {
			// é˜²æŠ–ï¼šå»¶è¿Ÿ 100ms æ‰§è¡Œï¼Œé¿å…çŸ­æ—¶é—´å†…å¤šæ¬¡è§¦å‘
			if (copyTimer) {
				clearTimeout(copyTimer);
			}
			copyTimer = setTimeout(() => {
				try {
					const newContent = fs.readFileSync(manifestPath, "utf8");
					// åªæœ‰å†…å®¹çœŸæ­£æ”¹å˜æ—¶æ‰å¤åˆ¶
					if (newContent !== lastContent) {
						lastContent = newContent;
						copyManifest();
					}
				} catch (e) {
					console.error("âš  è¯»å– manifest.json å¤±è´¥:", e.message);
				}
				copyTimer = null;
			}, 100);
		}
	});
}

// åˆ›å»º esbuild context
const context = await esbuild.context({
	banner: {
		js: banner,
	},
	entryPoints: ["src/main.ts"],
	bundle: true,
	plugins: [renamePlugin(), cssReBuild()],
	external: [
		"obsidian",
		"electron",
		"@codemirror/autocomplete",
		"@codemirror/collab",
		"@codemirror/commands",
		"@codemirror/language",
		"@codemirror/lint",
		"@codemirror/search",
		"@codemirror/state",
		"@codemirror/view",
		"@lezer/common",
		"@lezer/highlight",
		"@lezer/lr",
		...builtins,
	],
	format: "cjs",
	target: "es2020",
	logLevel: "info",
	sourcemap: prod ? false : "inline",
	treeShaking: true,
	outdir: outDir,
	minify: prod,
	drop: prod ? ["console"] : [],
	loader: {
		".ttf": "base64",
	},
});

// åˆå§‹æ„å»ºæ—¶å¤åˆ¶ manifest.json
copyManifest();

if (prod) {
	// ç”Ÿäº§æ¨¡å¼ï¼šæ„å»ºä¸€æ¬¡åé€€å‡º
	await context.rebuild();
	console.log("âœ… ç”Ÿäº§æ„å»ºå®Œæˆ");
	process.exit(0);
} else {
	// å¼€å‘æ¨¡å¼ï¼šç›‘å¬æ–‡ä»¶å˜åŒ–
	console.log("ğŸ‘€ å¼€å‘æ¨¡å¼å¯åŠ¨ï¼Œç›‘å¬æ–‡ä»¶å˜åŒ–...");
	watchManifest();
	await context.watch();
}
